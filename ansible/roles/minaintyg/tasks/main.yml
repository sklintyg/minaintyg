---

- name: stop tomcat
  service: name={{ tomcat_service }} state=stopped pattern=org.apache.catalina.startup.Bootstrap

- name: Download minaintyg-web-{{ version }}.war
  get_url: url=http://repository-callistasoftware.forge.cloudbees.com/release/se/inera/intyg/minaintyg/minaintyg-web/{{ version }}/minaintyg-web-{{ version }}.war
           dest={{ releases_folder }}

- name: remove old version of unpacked war
  file: state=absent
      path={{ webapps_folder }}/ROOT

- name: remove old version of war
  file: state=absent
      path={{ webapps_folder }}/ROOT.war

- name: Deploy minaintyg-web-{{ version }}.war as ROOT.war
  command: cp {{ releases_folder }}/minaintyg-web-{{ version }}.war {{ webapps_folder }}/ROOT.war

- name: Create version file
  template: src=version.txt.j2 dest={{ webapps_folder }}/version.txt

- name: update configuration
  command: chdir={{ config_folder }} git checkout {{ config_version }}
  command: chdir={{ config_folder }} git pull origin

- name: start tomcat
  service: name={{ tomcat_service }} state=started pattern=org.apache.catalina.startup.Bootstrap
